<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>(WebPKI.org Support)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="generator" content="javadoc/DocFileWriter">
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../../../script.js"></script>
</head>
<body class="doc-file-page">
<script type="text/javascript"></script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top">
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../index.html">Overview</a></li>
<li><a href="../package-summary.html">Package</a></li>
<li>Class</li>
<li><a href="../../../../overview-tree.html">Tree</a></li>
<li><a href="../../../../help-doc.html#doc-file">Help</a></li>
</ul>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main"><h2>Encryption Support</h2>
The CBOR library contains support for <a href="../CBOREncrypter.html" title="class in org.webpki.cbor"><code>Encrypting</code></a> 
and <a href="../CBORDecrypter.html" title="class in org.webpki.cbor"><code>Decrypting</code></a>
arbitrary binary data using a specific scheme called
&quot;CBOR Encryption Format&quot; (CEF).
In similarity to <a href='signatures.html'>CSF</a>, 
CEF also depends on 
<a href='../package-summary.html#deterministic-encoding'>Deterministic&nbsp;Encoding</a>
which is used to create authentication data to content encryption
algorithms like GCM.
<p>
The following is a CEF object (here expressed in CBOR diagnostic notation), using the algorithms
<code>A256GCM</code> and <code>ECDH-ES+A256KW</code> for content- respectively key-wrapping:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
{<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ Content encryption algorithm = A256GCM /</span><br>
&nbsp;&nbsp;1: 3,<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ Key encryption object /</span><br>
&nbsp;&nbsp;2: {<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ Key encryption algorithm = ECDH-ES+A256KW /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;1: -31,<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ Key Id /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;3: "example.com:x25519",<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ Ephemeral public key descriptor in COSE format /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;7: {<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ kty = OKP /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1: 1,<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ crv = X25519 /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1: 4,<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ x /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2: h'c219e35a9c09bfcf1bd6c6dcd1e05ecb36cb6f465d9caeb101795e33fd7db112'<br>
&nbsp;&nbsp;&nbsp;&nbsp;},<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;&nbsp;&nbsp;<span style='color:grey'>/ CipherText (Encrypted key) /</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;10: h'842916c5c81f8a815ec5ef2a472981b7300bc33fe748928c26e8c4dfff7a4747ecff9caea7040585'<br>
&nbsp;&nbsp;},<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ Tag /</span><br>
&nbsp;&nbsp;8: h'84ad6926aa92d0de56e4674abf863390',<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ Initialization Vector (IV) /</span><br>
&nbsp;&nbsp;9: h'c7cc6f77b9f984c15bc3cbeb',<br>
<div style='height:0.5em'></div>&nbsp;&nbsp;<span style='color:grey'>/ Ciphertext (Encrypted Content) /</span><br>
&nbsp;&nbsp;10: h'625c2b2a41907547b2210624e1e818991c00790aed16'<br>
}
</div>
</div>
<p>
The same object expressed as hex-encoded CBOR:
</p>
<div class='webpkihexbox'>
a5010302a401381e03726578616d706c652e636f6d3a78323535313907a301012004215820c219e35a9c09bfcf1bd6c6dcd1e05ecb36cb6f465d9caeb101795e33fd7db1120a5828842916c5c81f8a815ec5ef2a472981b7300bc33fe748928c26e8c4dfff7a4747ecff9caea7040585085084ad6926aa92d0de56e4674abf863390094cc7cc6f77b9f984c15bc3cbeb0a56625c2b2a41907547b2210624e1e818991c00790aed16
</div>
<p>
Decryption of this object using the private key (here in JWK format)
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
{<br>
&nbsp;&nbsp;&quot;kid&quot;:&nbsp;&quot;example.com:x25519&quot;,<br>
&nbsp;&nbsp;&quot;kty&quot;:&nbsp;&quot;OKP&quot;,<br>
&nbsp;&nbsp;&quot;crv&quot;:&nbsp;&quot;X25519&quot;,<br>
&nbsp;&nbsp;&quot;x&quot;:&nbsp;&quot;6ZoM7yBYlJYNmxwFl4UT3MtCoTv7ztUjpRuKEXrV8Aw&quot;,<br>
&nbsp;&nbsp;&quot;d&quot;:&nbsp;&quot;cxfl86EVmcqrR07mWENCf1F_5Ni5mt1ViGyERB6Q1vA&quot;<br>
}
</div>
</div>
should return the UTF-8 encoded string <code>&quot;Hello encrypted world!&quot;</code>.
<p>
The CEF decryption process is as follows:
</p>
<ul>
<li class='webpkilistspacing'>Read and save the content encryption parameters <code class='webpkicode'>tag</code>,
<code class='webpkicode'>iv</code>, and <code class='webpkicode'>ciphertext</code>.</li>
<li class='webpkilistspacing'>Remove the <code class='webpkicode'>tag</code>,
<code class='webpkicode'>iv</code>, and <code class='webpkicode'>ciphertext</code> elements from the
encryption object.
Note that the top level <code>map</code> object <b>must</b> be updated
as well to reflect the changed number of elements.
<li class='webpkilistspacing'>Serialize the remaining CBOR encryption object and set the result to 
Additional Authentication Data (<code>AAD</code>).</li>
<li class='webpkilistspacing'>Recover the content encryption key using the elements in the
key encryption object (argument of label <code>2</code>).</li>
<li>Apply the content encryption algorithm (argument of label <code>1</code> 
in the main map)
to the recovered content encryption key,
the input parameters read in the first step, and <code>AAD</code>.
The result is the decrypted content.</li>
</ul>
Symmetric key encryption CEF objects are processed as above, but
since they do not have a key encryption component, content encryption 
keys must be known by recipients.
<p id='parameters'>
The following figure shows the layout of CEF objects:
</p>
<div class='webpkifloat'>
<div class='webpkisvg'>
<img src='cbor-crypto.svg' alt='CEF object layout' style='height:20em;padding:0.2em 0.6em'/>
</div>
</div>
The numbers in paranthesis denote the actual label (map key) value.
Properly designed CEF objects <b>must</b> adhere to the following rules:
<ul>
<li class='webpkilistspacing'><code class='webpkicode'>publicKey</code> and <code class='webpkicode'>ephemeralKey</code> elements
<b>must</b> be compliant with COSE, but <b>must not</b> contain
any other information than the public key itself
and associated parameters.</li>
<li class='webpkilistspacing'>ECDSA public keys <b>must</b> be supplied with a <i>value parameter</i> for the y-coordinate as well.</li>
<li class='webpkilistspacing'><code class='webpkicode'>keyId</code>, <code class='webpkicode'>publicKey</code> 
and <code class='webpkicode'>certificatePath</code>
<b>must not</b> be combined.</li>
<li class='webpkilistspacing'>If a <code class='webpkicode'>keyId</code> is used it <b>must</b> be supplied in the main map for
symmetric encryption schemes, and in the sub map for schemes using key encryption.
A compliant <code>keyId</code> <b>must</b> uniquely identify a specific encryption key.</li>
<li class='webpkilistspacing'>The currently supported key encryption algorithms except for <code>ECDH-ES</code>
<b>require</b> that the encrypted key is provided in the <code class='webpkicode'>chipherText</code>
element in the sub map.</li>
<li>All ECDH-ES variants <b>must</b> include an <code class='webpkicode'>ephemeralKey</code>
element.</li>
</ul>
ECDH based key encryption schemes <b>must</b> use a Key Derivation Function (KDF)
according to HKDF (RFC&nbsp;5869), profiled as follows:
<ul>
<li class='webpkilistspacing'><code>hmac</code>: The HKDF implementation <b>must</b> use HMAC with SHA-256</li>
<li class='webpkilistspacing'><code>salt</code>: N/A. The default extract mode handling <b>must</b> be implemented.</li>
<li><code>info</code>: This parameter <b>must</b> consist of the actual
COSE key encryption algorithm,
expressed as a 32-bit (4 byte) signed big-endian integer.</li>
</ul>
<h3>Tagged and Custom Encryption Data</h3>
The CEF container can be enhanced through a couple of options
described in <a href='crypto-options.html'>Crypto Options</a>.
Such options are included in the data to be authenticated. 
<h3>Content Encryption Algorithms</h3>
<div id='cef-content-encryption-algorithms'>
Currently supported content encryption algorithms:
</div>
<div class='webpkifloat'>
<table class='webpkitable'>
<tr><th>Name</th><th>Identifier</th><th>Compatibility</th></tr>
<tr style='text-align:center'><td><code>A128GCM</code></td><td>1</td><td>COSE, JOSE</td></tr>
<tr style='text-align:center'><td><code>A192GCM</code></td><td>2</td><td>COSE, JOSE</td></tr>
<tr style='text-align:center'><td><code>A256GCM</code></td><td>3</td><td>COSE, JOSE</td></tr>
<tr style='text-align:center'><td><code>A128CBC-HS256</code></td><td>200</td><td>JOSE</td></tr>
<tr style='text-align:center'><td><code>A192CBC-HS384</code></td><td>201</td><td>JOSE</td></tr>
<tr style='text-align:center'><td><code>A256CBC-HS512</code></td><td>202</td><td>JOSE</td></tr>
</table>
</div>
<h3 style='margin-top:0.5em'>Key Encryption Algorithms</h3>
<div id='cef-key-encryption-algorithms'>
Currently supported key encryption algorithms:
</div>
<div class='webpkifloat'>
<table class='webpkitable'>
<tr><th>Name</th><th>Identifier</th><th>Compatibility</th></tr>
<tr style='text-align:center'><td><code>ECDH-ES</code></td><td>-25</td><td>COSE, JOSE [1]</td></tr>
<tr style='text-align:center'><td><code>ECDH-ES+A128KW</code></td><td>-29</td><td>COSE, JOSE [1]</td></tr>
<tr style='text-align:center'><td><code>ECDH-ES+A192KW</code></td><td>-30</td><td>COSE, JOSE [1]</td></tr>
<tr style='text-align:center'><td><code>ECDH-ES+A256KW</code></td><td>-31</td><td>COSE, JOSE [1]</td></tr>
<tr style='text-align:center'><td><code>RSA-OAEP</code></td><td>-40</td><td>COSE, JOSE</td></tr>
<tr style='text-align:center'><td><code>RSA-OAEP-256</code></td><td>-41</td><td>COSE, JOSE</td></tr>
</table>
</div>
[1] Note that COSE and JOSE do no use the same Key Derivation Function (KDF).
<h3 id='api-example'>Using the Encryption API</h3>
The following section outlines how the encryption API is supposed to be used.
<p>
Sample program:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
package&nbsp;cbor_api_demo;<br><br>import&nbsp;java.security.KeyPair;<br>import&nbsp;java.security.PrivateKey;<br>import&nbsp;java.security.PublicKey;<br><br>import&nbsp;org.webpki.cbor.CBORAsymKeyDecrypter;<br>import&nbsp;org.webpki.cbor.CBORAsymKeyEncrypter;<br>import&nbsp;org.webpki.cbor.CBORKeyPair;<br>import&nbsp;org.webpki.cbor.CBORObject;<br><br>import&nbsp;org.webpki.crypto.ContentEncryptionAlgorithms;<br>import&nbsp;org.webpki.crypto.KeyEncryptionAlgorithms;<br><br>import&nbsp;org.webpki.util.HexaDecimal;<br>import&nbsp;org.webpki.util.UTF8;<br><br>public&nbsp;class&nbsp;EncryptionDemo&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Message&nbsp;encoded&nbsp;in&nbsp;UTF-8.<br>&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;final&nbsp;byte[]&nbsp;SECRET_MESSAGE&nbsp;=&nbsp;UTF8.encode("A&nbsp;very&nbsp;secret&nbsp;message");<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;X25519&nbsp;private&nbsp;key&nbsp;in&nbsp;COSE&nbsp;format.<br>&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;final&nbsp;byte[]&nbsp;X25519_PRIVATE_KEY&nbsp;=&nbsp;HexaDecimal.decode(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"a401012004215820e99a0cef205894960d9b1c05978513dccb"&nbsp;+<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"42a13bfbced523a51b8a117ad5f00c2358207317e5f3a11599"&nbsp;+<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"caab474ee65843427f517fe4d8b99add55886c84441e90d6f0");<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;void&nbsp;main(String[]&nbsp;args)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Get&nbsp;keys&nbsp;in&nbsp;Java&nbsp;format.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KeyPair&nbsp;keyPair&nbsp;=&nbsp;CBORKeyPair.convert(CBORObject.decode(X25519_PRIVATE_KEY));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrivateKey&nbsp;receiverKey&nbsp;=&nbsp;keyPair.getPrivate();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PublicKey&nbsp;senderKey&nbsp;=&nbsp;keyPair.getPublic();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Encrypt&nbsp;data&nbsp;using&nbsp;CEF.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[]&nbsp;encryptionObject&nbsp;=&nbsp;new&nbsp;CBORAsymKeyEncrypter(senderKey,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KeyEncryptionAlgorithms.ECDH_ES,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentEncryptionAlgorithms.A256GCM)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.encrypt(SECRET_MESSAGE).encode();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Decrypt&nbsp;data&nbsp;using&nbsp;CEF.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[]&nbsp;decryptedData&nbsp;=&nbsp;new&nbsp;CBORAsymKeyDecrypter(receiverKey)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.decrypt(CBORObject.decode(encryptionObject));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Assume&nbsp;that&nbsp;the&nbsp;data&nbsp;is&nbsp;a&nbsp;string&nbsp;encoded&nbsp;in&nbsp;UTF-8.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;secretMessage&nbsp;=&nbsp;UTF8.decode(decryptedData);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(secretMessage);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br>
</div>
</div>
<p>
Sample key in diagnostic notation:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
{<br>&nbsp;&nbsp;1:&nbsp;1,<br>&nbsp;&nbsp;-1:&nbsp;4,<br>&nbsp;&nbsp;-2:&nbsp;h'e99a0cef205894960d9b1c05978513dccb42a13bfbced523a51b8a117ad5f00c',<br>&nbsp;&nbsp;-4:&nbsp;h'7317e5f3a11599caab474ee65843427f517fe4d8b99add55886c84441e90d6f0'<br>}
</div>
</div>
<p>
The resulting encryption object in diagnostic notation:
</p>
<div class='webpkifloat'>
<div class='webpkibox'>
{<br>&nbsp;&nbsp;1:&nbsp;3,<br>&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;-25,<br>&nbsp;&nbsp;&nbsp;&nbsp;7:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;4,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h'3e9c03b4e2ccb023272fe0f1a5a414645a7e5a0952a3da8199ba46812603ee1a'<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;8:&nbsp;h'4ac80be51285309b93b8f4cc38f6b8ba',<br>&nbsp;&nbsp;9:&nbsp;h'9fbd6e151bad2af177dd3382',<br>&nbsp;&nbsp;10:&nbsp;h'115b48dcffcf88dce70b2173d6c368b2cfe802521c'<br>}
</div>
</div>
<p>
The resulting encryption object expressed in hexadecimal:
</p>
<div class='webpkihexbox'>
a5010302a201381807a3010120042158203e9c03b4e2ccb023272fe0f1a5a414645a7e5a0952a3da8199ba46812603ee1a08504ac80be51285309b93b8f4cc38f6b8ba094c9fbd6e151bad2af177dd33820a55115b48dcffcf88dce70b2173d6c368b2cfe802521c
</div></main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small><i>2005-2023 WebPKI.org.</i></small></p>
</footer>
</div>
</div>
</body>
</html>
